<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>fied.analysis.analysis_figures</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../index.html" class="home-link">
    
      <span class="site-name">The Foundational Industry Energy Dataset (FIED)</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../index.html#fied-documentation-and-other-resources-on-u-s-industrial-energy-data">Contents:</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../../ind_data.html" class="reference internal ">Sources of Industrial Energy Data for the United States</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../nrel_data.html" class="reference internal ">NREL Industrial Energy Datasets</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../data_history.html" class="reference internal ">A Brief History of U.S. Industrial Energy Data</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../fied.html" class="reference internal ">fied package</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../../index.html">Module code</a> &raquo;</li>
    
    <li>fied.analysis.analysis_figures</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for fied.analysis.analysis_figures</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">pyarrow</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">pio</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>


<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<div class="viewcode-block" id="FIED_analysis">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis">[docs]</a>
<span class="k">class</span> <span class="nc">FIED_analysis</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pio_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
                    <span class="n">file_path</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">pyarrow</span><span class="o">.</span><span class="n">ArrowIOError</span><span class="p">,</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">ArrowInvalid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_consistent_naics_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_year</span> <span class="o">=</span> <span class="n">year</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./analysis/figures&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span> <span class="o">=</span> <span class="n">pio_engine</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">pass</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span> <span class="o">=</span> <span class="n">fig_format</span>

<div class="viewcode-block" id="FIED_analysis.get_cbp_data">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.get_cbp_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cbp_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get establishment counts from Census County Business</span>
<span class="sd">        Patterns for reporting year.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cbp_data : pandas.DataFrame</span>
<span class="sd">            DataFrame of CBP establishment counts by NAICS</span>
<span class="sd">            code for U.S. for specified year.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cbp_data_url</span> <span class="o">=</span> \
            <span class="sa">f</span><span class="s1">&#39;https://www2.census.gov/programs-surveys/cbp/datasets/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">/cbp</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s1">us.zip&#39;</span>
        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cbp_data_url</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">))</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">cbp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                    <span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> 
                    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lfo&#39;</span><span class="p">,</span> <span class="s1">&#39;naics&#39;</span><span class="p">,</span> <span class="s1">&#39;est&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                
        <span class="n">cbp_data</span> <span class="o">=</span> <span class="n">cbp_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;lfo == &quot;-&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cbp_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    
        <span class="n">cbp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;n_naics&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">cbp_data</span><span class="o">.</span><span class="n">naics</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    
        <span class="k">return</span> <span class="n">cbp_data</span></div>


<div class="viewcode-block" id="FIED_analysis.create_core_analysis">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.create_core_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">create_core_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create summary figures and table.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">summary_table_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_unit_table</span><span class="p">()</span>

        <span class="n">summary_table_eisghgrp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_unit_table</span><span class="p">(</span><span class="n">eis_or_ghgrp_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary_unit_bar</span><span class="p">(</span><span class="n">summary_table_all</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_rel_bar_missing</span><span class="p">(</span><span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_stacked_bar_missing</span><span class="p">(</span><span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ghgrp&#39;</span><span class="p">,</span> <span class="s1">&#39;nei&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_stacked_bar_missing</span><span class="p">(</span><span class="n">data_subset</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_facility_count</span><span class="p">(</span><span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_best_characterized</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">unitTypeStd</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;power&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_unit_bubble_map</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;capacity&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_ut_by_naics</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mecs&#39;</span><span class="p">,</span> <span class="s1">&#39;seds&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_eia_comparison_maps</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2017</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;write_fig&#39;</span><span class="p">])</span>

        <span class="k">return</span></div>

    

<div class="viewcode-block" id="FIED_analysis.summary_unit_table">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.summary_unit_table">[docs]</a>
    <span class="k">def</span> <span class="nf">summary_unit_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eis_or_ghgrp_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a table that summarizes by industrial sector</span>
<span class="sd">        (i.e., 2-digit NAICS) various aspects of the </span>
<span class="sd">        dataset. Saves table to analysis directory and returns table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        final_data : pandas.DataFrame or parquet</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        summary_table : pandas.DataFrame</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Multiple units can share the same eisUnitID.</span>
        <span class="c1"># (see evidence in unitDescription field)</span>
        <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">table_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_sectors</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eis_or_ghgrp_only</span><span class="p">:</span>
            <span class="n">table_data</span> <span class="o">=</span> <span class="n">table_data</span><span class="p">[</span>
                <span class="p">(</span><span class="n">table_data</span><span class="o">.</span><span class="n">eisFacilityID</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span><span class="o">|</span><span class="p">(</span><span class="n">table_data</span><span class="o">.</span><span class="n">ghgrpID</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
                <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./analysis/summary_unit_table_eisghgrp_only.csv&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./analysis/summary_unit_table_eisghgrp_only.csv&#39;</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span>

        <span class="n">_unit_count</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">_unit_count</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Count of Units&#39;</span>

        <span class="n">_capacity_summ</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;designCapacityUOM == &quot;MW&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        
        <span class="n">_capacity_summ</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Capacity_MW_&#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_capacity_summ</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c1"># Count of facilities with unit information</span>
        <span class="n">_fac_count</span> <span class="o">=</span> <span class="n">table_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;unitTypeStd.notnull()&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">_fac_count</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Count of Facilities&#39;</span>

        <span class="c1"># Only use non-zero value</span>
        <span class="n">_energy_summ_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">table_data</span><span class="p">[</span><span class="n">table_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;energyMJ&#39;</span><span class="p">,</span> <span class="s1">&#39;energyMJq0&#39;</span><span class="p">,</span> <span class="s1">&#39;energyMJq2&#39;</span><span class="p">,</span> <span class="s1">&#39;energyMJq3&#39;</span><span class="p">]],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">agg_energy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">e_agg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">e_agg</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">e_agg</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;energyMJ</span><span class="si">{</span><span class="nb">type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
            <span class="n">e_agg</span> <span class="o">=</span> <span class="n">e_agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">e_agg</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;EnergyMJ_</span><span class="si">{</span><span class="nb">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="k">return</span> <span class="n">e_agg</span>
        
        <span class="n">_energy_summ_agg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">agg_energy</span><span class="p">(</span><span class="n">_energy_summ_</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;q0&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">]]],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="n">_throughput_summ</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">throughputTonneQ2</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">throughputTonneQ2</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">throughputTonneQ2</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">),</span>
                <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">throughputTonneQ0</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">throughputTonneQ2</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
                <span class="n">table_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">throughputTonneQ3</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        
        <span class="n">_throughput_summ</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ThroughputTonnes_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]]</span>

        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">_unit_count</span><span class="p">,</span> <span class="n">_capacity_summ</span><span class="p">,</span> <span class="n">_energy_summ_agg</span><span class="p">,</span> <span class="n">_throughput_summ</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_fac_count</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_table</span><span class="p">)</span>

        <span class="n">summary_table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./analysis/summary_unit_table.csv&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary_table</span></div>


<div class="viewcode-block" id="FIED_analysis.plot_facility_count">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_facility_count">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_facility_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Plots the count of facilities from foundational data</span>
<span class="sd">        and the count of establishments from the corresponding</span>
<span class="sd">        year of Census Business Patterns (CBP) data.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write resulting figure to analysis figures</span>
<span class="sd">            directory.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ind_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;11&#39;</span><span class="p">:</span> <span class="s1">&#39;Agriculture&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;21&#39;</span><span class="p">:</span> <span class="s1">&#39;Mining&#39;</span><span class="p">,</span>
            <span class="s1">&#39;23&#39;</span><span class="p">:</span> <span class="s1">&#39;Construction&#39;</span><span class="p">,</span>
            <span class="s1">&#39;31&#39;</span><span class="p">:</span> <span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;32&#39;</span><span class="p">:</span> <span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;33&#39;</span><span class="p">:</span> <span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">cbp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cbp_data</span><span class="p">()</span>

        <span class="c1"># Some foundational data reported at 4-digit NAICS level.</span>
        <span class="c1"># So, will be aggregating counts at 4-digit level.</span>
        <span class="c1"># Note that CBP doesn&#39;t track ag establishments for NAICS 111 - 112</span>
        <span class="c1"># (essentially all farming, animal production, and aquaculture)</span>
        <span class="n">cbp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbp_data</span><span class="o">.</span><span class="n">naics</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;21&#39;</span><span class="p">,</span> <span class="s1">&#39;23&#39;</span><span class="p">,</span> <span class="s1">&#39;31&#39;</span><span class="p">,</span> <span class="s1">&#39;32&#39;</span><span class="p">,</span> <span class="s1">&#39;33&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Total count of industrial establishments</span>
        <span class="n">total_est</span> <span class="o">=</span> <span class="n">cbp_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">cbp_data</span><span class="o">.</span><span class="n">naics</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ind_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">est</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="n">ind_cbp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cbp_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;ind == True&quot;</span><span class="p">))</span>
        <span class="n">ind_cbp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;naics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_cbp_data</span><span class="o">.</span><span class="n">naics</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">fied_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fied_count</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;n4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fied_count</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">fied_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">fied_count</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;n4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unique</span><span class="p">())),</span>
            <span class="n">ind_cbp_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;naics&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">est</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">index_str</span> <span class="o">=</span> <span class="n">fied_count</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">fied_count</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_str</span>
        <span class="n">fied_count</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fied_count</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ind_map</span><span class="p">)</span>
        
        <span class="n">fied_cumsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">fied_count</span><span class="p">[[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;sector&#39;</span><span class="p">]],</span>
            <span class="n">fied_count</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">])[[</span><span class="s1">&#39;registryID&#39;</span><span class="p">,</span> <span class="s1">&#39;est&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span>
            <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
            <span class="n">fied_cumsum</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
                <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;sector&#39;</span><span class="p">]),</span> 
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span>
            <span class="n">facet_col</span><span class="o">=</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">markers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;NAICS Code&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;Cumulative Count of Establishments&lt;br&gt;or Registry IDs&#39;</span><span class="p">,</span>
                <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;Data Source&#39;</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Foundational Data&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;County Business Patterns&#39;</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
            <span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">titlefont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span> <span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">titlefont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span> <span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">&#39;presentation&#39;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="p">)</span>
    
        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;counts_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


 
<div class="viewcode-block" id="FIED_analysis.plot_difference_nei">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_difference_nei">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_difference_nei</span><span class="p">(</span><span class="n">nei</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot difference between max and min energy or</span>
<span class="sd">        throughput quanitites for units when there are</span>
<span class="sd">        multiple emissions per unit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nei : pandas.DataFrame</span>
<span class="sd">            Unformatted NEI, prior to estimating</span>
<span class="sd">            quartile values for throughput and energy.</span>

<span class="sd">        data : str; &#39;energy&#39; or &#39;throughput&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">selection</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;energy_MJ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy&#39;</span>
                <span class="p">},</span>
            <span class="s1">&#39;throughput&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="s1">&#39;throughput_TON&#39;</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Throughput&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="n">duplic</span> <span class="o">=</span> <span class="n">nei</span><span class="p">[(</span><span class="n">nei</span><span class="p">[</span><span class="n">selection</span><span class="p">[</span><span class="n">data</span><span class="p">][</span><span class="s1">&#39;columns&#39;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">nei</span><span class="o">.</span><span class="n">eis_process_id</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span>

        <span class="n">duplic</span> <span class="o">=</span> <span class="n">duplic</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;eis_process_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">perc_diff</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">selection</span><span class="p">[</span><span class="n">data</span><span class="p">][</span><span class="s1">&#39;column&#39;</span><span class="p">],</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">*</span><span class="mi">100</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Arial&quot;</span> 

        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">duplic</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;perc_diff&quot;</span><span class="p">)</span>  <span class="c1"># sns.kdeplot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Percentage difference&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="n">data</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="FIED_analysis.id_sectors">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.id_sectors">[docs]</a>
    <span class="k">def</span> <span class="nf">id_sectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a new sector column for NAICS 2-digit</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            FIED with 2-digit NAICS code column</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;n2&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_consistent_naics_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">sectors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s1">&#39;Agriculture&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Construction&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Mining&#39;</span><span class="p">,</span> <span class="mi">23</span><span class="p">],</span> 
            <span class="p">[</span><span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">],</span> 
            <span class="p">[</span><span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span> <span class="mi">33</span><span class="p">]],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;n2&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;n2&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="FIED_analysis.summary_unit_bar">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.summary_unit_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">summary_unit_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_table</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make stacked bar chart showing units by Sector and</span>
<span class="sd">        total number of facilities reporting units</span>

<span class="sd">        Paramters</span>
<span class="sd">        ---------</span>
<span class="sd">        summary_table : pandas.DataFrame</span>
<span class="sd">            Output of `summary_unit_table` method.</span>

<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write figure to analysis figures directory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">summary_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">len_unit_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">unitTypeStd</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;secondary_y&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]])</span>

        <span class="n">plot_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Count of Units&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">fig_units</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">plot_data</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Count of Units&#39;</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;Facility Count&#39;</span><span class="p">,</span>
                <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;Facilities&#39;</span>
                <span class="p">},</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;unitTypeStd&#39;</span><span class="p">,</span>
            <span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Alphabet</span>
            <span class="c1"># color_discrete_sequence=px.colors.sample_colorscale(</span>
            <span class="c1">#     &quot;plasma&quot;, [n/(len_unit_types-1) for n in range(len_unit_types)]</span>
            <span class="c1">#     )</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig_units</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">fig_units</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">fac_counts</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;Count of Facilities&#39;</span><span class="p">])</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">barmode</span><span class="o">=</span><span class="s1">&#39;stack&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="n">fac_counts</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">fac_counts</span><span class="p">[</span><span class="s1">&#39;Count of Facilities&#39;</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;LightSkyBlue&#39;</span><span class="p">),</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Facilities&#39;</span>
            <span class="p">),</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Count of Units&#39;</span><span class="p">,</span>
                        <span class="n">secondary_y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70000</span><span class="p">],</span>
                        <span class="n">tickmode</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                        <span class="n">tick0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">dtick</span><span class="o">=</span><span class="mi">7000</span>
                        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Count of Facilities&#39;</span><span class="p">,</span>
                        <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">],</span>
                        <span class="n">tickmode</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                        <span class="n">tick0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">dtick</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Sector&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">&#39;presentation&#39;</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;Unit Type&#39;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span> <span class="n">yanchor</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.99</span><span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span>
            <span class="p">)</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;summary_figure_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> 
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="FIED_analysis.set_mecs_data">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.set_mecs_data">[docs]</a>
    <span class="k">def</span> <span class="nf">set_mecs_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2018</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        MECS format is not machine-friendly. This is a manual input</span>
<span class="sd">        of MECS combustion energy estimates from MECS Table 3.2:</span>
<span class="sd">        https://www.eia.gov/consumption/manufacturing/about.php</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mecs : dict</span>
<span class="sd">            Dictionary of combustion energy estimates from MECS (converted from TBtu to MJ), on</span>
<span class="sd">            a national and census region basis.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mecs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">2018</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;nation&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">14859</span> <span class="o">-</span> <span class="mi">2591</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.055E9</span><span class="p">,</span>
                <span class="s1">&#39;northeast&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1130</span> <span class="o">-</span> <span class="mi">250</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.055E9</span> <span class="p">,</span>
                <span class="s1">&#39;midwest&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3907</span> <span class="o">-</span> <span class="mi">834</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.055E9</span><span class="p">,</span>
                <span class="s1">&#39;south&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7897</span> <span class="o">-</span> <span class="mi">1143</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.055E9</span><span class="p">,</span>
                <span class="s1">&#39;west&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1925</span> <span class="o">-</span> <span class="mi">365</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.055E9</span>
                <span class="p">}</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">mecs</span><span class="p">[</span><span class="n">year</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="FIED_analysis.get_eia_seds">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.get_eia_seds">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eia_seds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2017</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get EIA State Energy Data System (SEDS) data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        year : int; default=2017</span>
<span class="sd">            Year of SEDS data to return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        seds : pandas.DataFrame</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seds_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.eia.gov/opendata/bulk/SEDS.zip&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">seds_url</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">r</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">))</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">zf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">seds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># eia_data = pd.DataFrame.from_dict(f)</span>


        <span class="n">seds</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;series_id&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">seds</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Natural gas consumed by the industrial sector (including supplemental gaseous fuels)</span>
        <span class="c1"># All petroleum products consumed by the industrial sector</span>
        <span class="c1"># Coal consumed by the industrial sector</span>
        <span class="c1"># Wood and waste consumed in the industrial sector</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NGICB&#39;</span><span class="p">,</span> <span class="s1">&#39;PAICB&#39;</span> <span class="p">,</span> <span class="s1">&#39;CLICB&#39;</span><span class="p">,</span> <span class="s1">&#39;WWICB&#39;</span><span class="p">]</span>

        <span class="n">seds</span> <span class="o">=</span> <span class="n">seds</span><span class="p">[</span><span class="n">seds</span><span class="o">.</span><span class="n">series_id</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">])</span>
            <span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">seds</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">final_seds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seds</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">seds</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">],</span> 
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;BillionBtu&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">seds</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">seds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">final_seds</span> <span class="o">=</span> <span class="n">final_seds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seds</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">final_seds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">v</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">final_seds</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">final_seds</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="n">final_seds</span> <span class="o">=</span> <span class="n">final_seds</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;year==@year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">final_seds</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;MJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_seds</span><span class="o">.</span><span class="n">BillionBtu</span> <span class="o">*</span> <span class="mf">1.055E6</span>
        <span class="n">final_seds</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;BillionBtu&#39;</span><span class="p">,</span> <span class="s1">&#39;last_updated&#39;</span><span class="p">],</span> 
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">final_seds</span> <span class="o">=</span> <span class="n">final_seds</span><span class="p">[</span><span class="n">final_seds</span><span class="o">.</span><span class="n">geography</span> <span class="o">!=</span> <span class="s1">&#39;USA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">split_columns</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

            <span class="n">final_seds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">final_seds</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_column&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_column&#39;</span><span class="p">]]</span>
                <span class="p">)</span>

            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;new_column&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_column&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;split_char&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            
            <span class="n">final_seds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_seds</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;data_column&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">final_seds</span>

        <span class="n">final_seds</span> <span class="o">=</span> <span class="n">split_columns</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">final_seds</span><span class="p">,</span>
            <span class="n">data_column</span><span class="o">=</span> <span class="s1">&#39;geography&#39;</span><span class="p">,</span> 
            <span class="n">new_column</span><span class="o">=</span><span class="s1">&#39;state&#39;</span><span class="p">,</span>
            <span class="n">split_char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span>
            <span class="p">)</span>

        <span class="c1"># final_seds = split_columns(</span>
        <span class="c1">#     data = final_seds,</span>
        <span class="c1">#     data_column = &#39;series_id&#39;, </span>
        <span class="c1">#     new_column=&#39;data_id&#39;,</span>
        <span class="c1">#     split_char= &#39;.&#39;</span>
        <span class="c1">#     )</span>

        <span class="c1"># states = pd.DataFrame(final_seds.geography.unique(), columns=[&#39;geography&#39;])</span>
        <span class="c1"># states.loc[:, &#39;state&#39;] = states.geography.apply(</span>
        <span class="c1">#     lambda x: x.split(&#39;-&#39;)[1]</span>
        <span class="c1">#     )</span>
        
        <span class="c1"># final_seds = pd.merge(final_seds, states, on=&#39;geography&#39;, how=&#39;left&#39;)</span>

        <span class="n">final_seds</span> <span class="o">=</span> <span class="n">final_seds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">MJ</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">final_seds</span></div>



<div class="viewcode-block" id="FIED_analysis.get_state_region">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.get_state_region">[docs]</a>
    <span class="k">def</span> <span class="nf">get_state_region</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Download state to region file&quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/cphalpert/census-regions/master/us</span><span class="si">%20c</span><span class="s1">ensus%20bureau</span><span class="si">%20r</span><span class="s1">egions</span><span class="si">%20a</span><span class="s1">nd</span><span class="si">%20d</span><span class="s1">ivisions.csv&#39;</span>
    
        <span class="n">s_r</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin_1&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s_r</span></div>

    
<div class="viewcode-block" id="FIED_analysis.plot_eia_comparison_maps">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_eia_comparison_maps">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_eia_comparison_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2017</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots a relative comparison of FIED vs. EIA on a geographic </span>
<span class="sd">        basis (combustion energy only). </span>
<span class="sd">        For MECS, this is census region; for SEDS, states.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataset : str; {&#39;mecs&#39;, &#39;seds&#39;}</span>
<span class="sd">            EIA dataset to compare FIED against.</span>

<span class="sd">        year : int; default=2017</span>

<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write figure to analysis figures directory</span>

<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shared_plot_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">color_continuous_scale</span><span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rgb(43,131,186)&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;rgb(171,221,164)&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;rgb(255,255,191)&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="s1">&#39;rgb(253,174,97)&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rgb(215,25,28)&#39;</span><span class="p">]</span>
                <span class="p">],</span>
            <span class="n">color_continuous_midpoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">locationmode</span><span class="o">=</span><span class="s2">&quot;USA-states&quot;</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;usa&#39;</span><span class="p">,</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="s1">&#39;stateCode&#39;</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;fied_relative&#39;</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fied_relative&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;FIED relative to EIA </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># with requests.get(&#39;https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/us-state-boundaries/exports/geojson?lang=en&amp;timezone=America%2FNew_York&#39;) as r:</span>
        <span class="c1">#     states = r.json()</span>

        <span class="c1"># for s in range(0, len(states[&#39;features&#39;])):</span>
        <span class="c1">#     states[&#39;features&#39;][s][&#39;id&#39;] =  states[&#39;features&#39;][s][&#39;properties&#39;][&#39;stusab&#39;]</span>

        <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;mecs&#39;</span><span class="p">:</span>
            
            <span class="n">mecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_mecs_data</span><span class="p">()</span>

            <span class="n">s_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state_region</span><span class="p">()[[</span><span class="s1">&#39;State Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Region&#39;</span><span class="p">]]</span>
            <span class="n">s_r</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">s_r</span><span class="o">.</span><span class="n">Region</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">plot_data</span><span class="p">,</span> <span class="n">s_r</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;stateCode&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;State Code&#39;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span>
                <span class="p">)</span>
            
            <span class="c1"># Need to remove non-manufacturing facilities</span>
            <span class="n">plot_data_n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">plot_data_n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">plot_data_n</span><span class="p">,</span> <span class="n">plot_data_n</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="n">plot_data_n</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;naicsCode&#39;</span><span class="p">,</span> <span class="s1">&#39;n1&#39;</span><span class="p">]</span>
            <span class="n">plot_data_n</span> <span class="o">=</span> <span class="n">plot_data_n</span><span class="p">[</span><span class="n">plot_data_n</span><span class="o">.</span><span class="n">n1</span><span class="o">==</span><span class="mi">3</span><span class="p">]</span>

            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">plot_data_n</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                 <span class="n">on</span><span class="o">=</span><span class="s1">&#39;naicsCode&#39;</span><span class="p">)</span>
            
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">plot_data</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                        <span class="p">[</span><span class="s1">&#39;Region&#39;</span><span class="p">,</span> <span class="s1">&#39;stateCode&#39;</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">energyMJq2</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                        <span class="p">[</span><span class="s1">&#39;Region&#39;</span><span class="p">,</span> <span class="s1">&#39;stateCode&#39;</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;totalMJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;mecsMJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mecs</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;fied_relative&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">plot_data</span><span class="o">.</span><span class="n">totalMJ</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">mecsMJ</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;seds&#39;</span><span class="p">:</span>

            <span class="n">seds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eia_seds</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2017</span><span class="p">)</span>
            <span class="n">seds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;MJ&#39;</span><span class="p">:</span> <span class="s1">&#39;sedsMJ&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">plot_data</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;stateCode&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">energyMJq2</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;stateCode&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">energyMJ</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            
            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;totalMJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seds</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">))</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;fied_relative&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">plot_data</span><span class="o">.</span><span class="n">totalMJ</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">sedsMJ</span><span class="p">)</span>
            
            <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
            <span class="n">plot_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Drop Territories</span>

        <span class="n">rel_max</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">fied_relative</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">rel_max</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">rel_max</span><span class="p">):</span>
            <span class="n">rel_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">rel_max</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>   
            <span class="n">rel_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">rel_max</span><span class="p">)</span>

        <span class="n">shared_plot_args</span><span class="p">[</span><span class="s1">&#39;range_color&#39;</span><span class="p">]</span> <span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rel_max</span><span class="p">)</span>
        <span class="n">shared_plot_args</span><span class="p">[</span><span class="s1">&#39;data_frame&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span>

        <span class="n">plot_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">_comparison_data.csv&#39;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">choropleth</span><span class="p">(</span><span class="o">**</span><span class="n">shared_plot_args</span><span class="p">)</span>
            <span class="c1"># plot_data,</span>
            <span class="c1"># color_continuous_scale= [</span>
            <span class="c1">#     [0, &#39;rgb(43,131,186)&#39;],</span>
            <span class="c1">#     [0.25, &#39;rgb(171,221,164)&#39;],</span>
            <span class="c1">#     [0.5, &#39;rgb(255,255,191)&#39;],</span>
            <span class="c1">#     [0.75, &#39;rgb(253,174,97)&#39;],</span>
            <span class="c1">#     [1, &#39;rgb(215,25,28)&#39;]</span>
            <span class="c1">#     ],</span>
            <span class="c1"># range_color=(0, rel_max),</span>
            <span class="c1"># color_continuous_midpoint=1,</span>
            <span class="c1"># locationmode=&quot;USA-states&quot;,</span>
            <span class="c1"># scope=&#39;usa&#39;,</span>
            <span class="c1"># locations = &#39;stateCode&#39;,</span>
            <span class="c1"># color = &#39;fied_relative&#39;,</span>
            <span class="c1">#     labels={&#39;fied_relative&#39;: &#39;FIED Relative to EIA MECS&#39;}</span>
            <span class="c1"># )</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;t&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;l&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">_comaprison_map_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> 
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

            
    
<div class="viewcode-block" id="FIED_analysis.plot_eia_comparison">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_eia_comparison">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_eia_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eia_mecs</span><span class="o">=</span><span class="mf">1.568E13</span><span class="p">,</span> <span class="n">eia_mer</span><span class="o">=</span><span class="mf">2.316E13</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot bar chart depicting FIED energy estimates relative to EIA estimates.    </span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        eia_mecs : float; default=1.568E13</span>
<span class="sd">            Combustion energy use (in MJ) from EIA Manufacturing Consumption survey. </span>
<span class="sd">            Default represents 2018 value.</span>

<span class="sd">        eia_mer : float; default=2.316E13</span>
<span class="sd">            Combustion energy use (in MJ) for industry from EIA Monthly Energy Review (MER).</span>
<span class="sd">            Default represents 2017 value. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span></div>




<div class="viewcode-block" id="FIED_analysis.plot_unit_bubble_map">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_unit_bubble_map">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_unit_bubble_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_type</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">66</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot locations of a single standard unit type by</span>
<span class="sd">        either energy (MJ) or design capacity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unit_type : str</span>
<span class="sd">            Standard unit type: &#39;other combustion&#39;, &#39;kiln&#39;, &#39;dryer&#39;, </span>
<span class="sd">            &#39;boiler&#39;, &#39;heater&#39;, &#39;turbine&#39;, &#39;oven&#39;, &#39;engine&#39;, &#39;furnace&#39;, </span>
<span class="sd">            &#39;thermal oxidizer&#39;, &#39;incinerator&#39;, &#39;other&#39;, &#39;generator&#39;, </span>
<span class="sd">            &#39;flare&#39;, &#39;stove&#39;, &#39;compressor&#39;, &#39;pump&#39;,</span>
<span class="sd">            &#39;building heat&#39;, &#39;distillation&#39;</span>

<span class="sd">        measure : str; {&#39;energy&#39;, &#39;power&#39;, &#39;ghgs&#39;}</span>
<span class="sd">            Either &#39;energy&#39; (results in MJ), &#39;power&#39; (results in MW), or</span>
<span class="sd">            &#39;ghgs&#39; (results in MTCO2e)</span>

<span class="sd">        max_size : int</span>
<span class="sd">            Max size of bubbles on map</span>

<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write figure to analysis figures directory</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">unit_type</span><span class="p">:</span>

            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd == @unit_type&quot;</span><span class="p">))</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;bubble_map_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">unit_type</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;bubble_map_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># plot_args = {</span>
        <span class="c1">#     &#39;lat&#39;: &#39;latitude&#39;,</span>
        <span class="c1">#     &#39;lon&#39;: &#39;longitude&#39;,</span>
        <span class="c1">#     &#39;scope&#39;: &#39;usa&#39;,</span>
        <span class="c1">#     &#39;color&#39;: &#39;unitTypeStd&#39;,</span>
        <span class="c1">#     &#39;title&#39;: f&#39;Location of {unit_type.title()} Units Reporting {measure.title()} Data&#39;,</span>
        <span class="c1">#     &#39;size_max&#39;: max_size,</span>
        <span class="c1">#     &#39;color_discrete_sequence&#39;: px.colors.qualitative.Safe</span>
        <span class="c1">#     }</span>
        

        <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;energy&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;plotMJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;energyMJ&gt;0 &amp; (energyMJq2.isnull() | energyMJq2==0)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">energyMJ</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;plotMJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(energyMJ==0 | energyMJ.isnull()) &amp; energyMJq2&gt;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">energyMJq2</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plotMJ&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># plot_args[&#39;size&#39;] = plot_data.plotMJ.to_list()</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">plotMJ</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="c1"># plot_args[&#39;labels&#39;] = {</span>
            <span class="c1">#     &#39;plotMJ&#39;: &#39;Unit Energy Use (MJ)&#39;</span>
            <span class="c1">#     }</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> MJ&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">plotMJ</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">leg_title</span> <span class="o">=</span> <span class="s1">&#39;Unit Energy Use (MJ)&#39;</span>
            <span class="n">plot_color</span><span class="o">=</span><span class="s1">&#39;plotMJ&#39;</span>

        <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;designCapacityUOM==&#39;MW&#39; &amp; designCapacity&gt;0&quot;</span>
                <span class="p">)</span>
            <span class="c1"># plot_args[&#39;size&#39;] = plot_data.designCapacity.to_list()</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="c1"># plot_args[&#39;labels&#39;] = {</span>
            <span class="c1">#     &#39;designCapacity&#39;: &#39;Unit Capacity (MW)&#39;</span>
            <span class="c1">#     }</span>
            <span class="c1"># plot_args[&#39;title&#39;] = f&#39;Location of {unit_type.title()} Units Reporting Capacity Data&#39;</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> MW&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">leg_title</span> <span class="o">=</span> <span class="s1">&#39;Unit Capacity (MW)&#39;</span>
            <span class="n">plot_color</span><span class="o">=</span><span class="s1">&#39;designCapacity&#39;</span>

        
        <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;ghgs&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;plotGHG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;ghgsTonneCO2e&gt;0 &amp; (ghgsTonneCO2eQ2.isnull() | ghgsTonneCO2eQ2==0)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ghgsTonneCO2e</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;plotGHG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(ghgsTonneCO2e==0 | ghgsTonneCO2e.isnull()) &amp; ghgsTonneCO2eQ2&gt;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ghgsTonneCO2eQ2</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plotGHG&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_color</span> <span class="o">=</span> <span class="s1">&#39;plotGHG&#39;</span>

            <span class="c1"># plot_args[&#39;size&#39;] = plot_data.plotGHG.to_list()</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">plotGHG</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

            <span class="c1"># plot_args[&#39;size&#39;] = plot_data.plotGHG.to_list()</span>
            <span class="c1"># plot_args[&#39;labels&#39;] = {</span>
            <span class="c1">#     &#39;plotGHG&#39;: &#39;Unit GHG Emissions (tonne CO2e)&#39;</span>
            <span class="c1">#     }</span>
            <span class="c1"># plot_args[&#39;title&#39;] = f&#39;Location of {unit_type.title()} Units Reporting GHG Data&#39;</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1"> tonne CO2e&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">plotGHG</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">leg_title</span> <span class="o">=</span> <span class="s1">&#39;Unit GHG Emissions (tonne CO2e)&#39;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergeo</span><span class="p">(</span>
            <span class="n">locationmode</span><span class="o">=</span><span class="s1">&#39;USA-states&#39;</span><span class="p">,</span> 
            <span class="n">lat</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                <span class="n">sizeref</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">markersize</span><span class="p">)</span><span class="o">/</span><span class="n">max_size</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">sizemode</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">,</span>
                <span class="n">autocolorscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="n">plot_color</span><span class="p">],</span>
                <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;agsunset&#39;</span><span class="p">,</span>
                <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">leg_title</span><span class="p">,</span>
                    <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Location of </span><span class="si">{</span><span class="n">unit_type</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> Units Reporting </span><span class="si">{</span><span class="n">measure</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> Data&#39;</span><span class="p">,</span>
            <span class="n">geo</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;usa&#39;</span><span class="p">,</span>
                <span class="n">projection_type</span><span class="o">=</span><span class="s1">&#39;albers usa&#39;</span><span class="p">,</span>
                <span class="n">showland</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">landcolor</span> <span class="o">=</span> <span class="s2">&quot;rgb(255, 255, 255)&quot;</span><span class="p">,</span>
                <span class="n">subunitcolor</span> <span class="o">=</span> <span class="s2">&quot;rgb(150, 150, 150)&quot;</span><span class="p">,</span>
                <span class="n">subunitwidth</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># fig = px.scatter_geo(plot_data, **plot_args)</span>
        <span class="c1"># fig.update_geos(bgcolor=&#39;#FFFFFF&#39;)</span>
        <span class="c1"># fig.update_layout(showlegend=True)</span>
        <span class="c1"># fig.update_yaxes(automargin=True)</span>
        <span class="c1"># fig.update_xaxes(automargin=True)</span>

        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="FIED_analysis.plot_rel_bar_missing">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_rel_bar_missing">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_rel_bar_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a simple stacked bar showing relative amount (percentage)</span>
<span class="sd">        of GHGRP and NEI facilities with and without unit-level data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write figure to analysis figures directory</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Percentage of Facilities with Unit-Level Characterization&quot;</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ghgrp&#39;</span><span class="p">,</span> <span class="s1">&#39;eisFacility&#39;</span><span class="p">]:</span>
            <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">ID.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd.isnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="p">)),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="p">))],</span> 
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            
            <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Without Unit Characterization&#39;</span><span class="p">,</span> 
                                   <span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">]</span>
            
            <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            
            <span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Data Source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        
        <span class="n">plot_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Without Unit Characterization&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">plot_data</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;eisFacility&#39;</span><span class="p">:</span> <span class="s1">&#39;NEI&#39;</span><span class="p">,</span> <span class="s1">&#39;ghgrp&#39;</span><span class="p">:</span> <span class="s1">&#39;GHGRP&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">plot_data</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Data Source&#39;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">],</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;Facilities&#39;</span>
                <span class="p">},</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
            <span class="n">color_discrete_map</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">:</span> <span class="s2">&quot;#756bb1&quot;</span>
                <span class="p">})</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">yaxis_tickformat</span><span class="o">=</span><span class="s2">&quot;.0%&quot;</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">&#39;presentation&#39;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;rel_bar_unit_char_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="FIED_analysis.plot_stacked_bar_missing">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_stacked_bar_missing">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_stacked_bar_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">naics_level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">data_subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Creates stacked bar showing counts of facilities</span>
<span class="sd">        with and without unit-level data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        naics_level : int; default=2</span>
<span class="sd">            Specific level of NAICS aggregation to display</span>
<span class="sd">            data. NAICS is a range of integers from 2 to 6.</span>
<span class="sd">            </span>
<span class="sd">        data_subset : str; {None, &#39;ghgrp&#39;, &#39;nei&#39;}</span>
<span class="sd">            Plot subset of data, either facilities that </span>
<span class="sd">            are GHGRP or NEI reporters</span>

<span class="sd">        rel_total : bool; default=False</span>
<span class="sd">            Plot the relative total of NEI and GHGRP facilities that</span>
<span class="sd">            have unit-level characterization. Renders naics_level and data_subset </span>
<span class="sd">            obsolete. </span>

<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write figure to analysis figures directory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Facility Count&quot;</span>
        
        <span class="k">if</span> <span class="n">data_subset</span> <span class="o">==</span> <span class="s1">&#39;ghgrp&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;ghgrpID.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot; (GHGRP Reporters Only)&quot;</span>

        <span class="k">elif</span> <span class="n">data_subset</span> <span class="o">==</span> <span class="s1">&#39;nei&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;eisFacilityID.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot; (NEI Reporters Only)&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd.isnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">())),</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">()))],</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">naics_level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Manufacturing&#39;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">31</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Without Unit Characterization&#39;</span><span class="p">,</span> 
                                 <span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">]</span>
        
            <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;Agriculture&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">:</span> <span class="s1">&#39;Mining&#39;</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span> <span class="s1">&#39;Construction&#39;</span><span class="p">},</span>
                              <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[[</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="nb">int</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">]]]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Without Unit Characterization&#39;</span><span class="p">,</span> 
                                <span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">]</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;NAICS Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Without Unit Characterization&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">],</span>
                    <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                        <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;Facilities&#39;</span>
                        <span class="p">},</span>
                    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
                    <span class="n">color_discrete_map</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;Without Unit Characterization&#39;</span><span class="p">:</span> <span class="s2">&quot;#bcbddc&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;With Unit Characterization&#39;</span><span class="p">:</span> <span class="s2">&quot;#756bb1&quot;</span>
                        <span class="p">})</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">template</span><span class="o">=</span><span class="s1">&#39;presentation&#39;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;stacked_bar_NAICS</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">data_subset</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FIED_analysis.plot_ut_by_naics">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_ut_by_naics">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_ut_by_naics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">naics_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">write_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a table that summarizes by industrial sector</span>
<span class="sd">        (i.e., 2-digit NAICS) various aspects of the dataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        naics_level : int; default=None</span>
<span class="sd">            Specified NAICS level (None or 2 - 6)</span>

<span class="sd">        variable : str; {&#39;count&#39;, &#39;energy&#39;, &#39;capacity&#39;}</span>

<span class="sd">        write_fig : bool; default=True</span>
<span class="sd">            Write figure to analysis figures directory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">formatting</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">,</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="s1">&#39;presentation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">:</span> <span class="s1">&#39;Standardized Unit Type&#39;</span>
                <span class="p">},</span>
            <span class="p">}</span>
        
        <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

        <span class="k">if</span> <span class="ow">not</span> <span class="n">naics_level</span><span class="p">:</span>

            <span class="n">grouper</span> <span class="o">=</span> <span class="s1">&#39;unitTypeStd&#39;</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">grouper</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;unitTypeStd&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">naics_level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_consistent_naics_column</span><span class="p">(</span>
                    <span class="n">plot_data</span><span class="p">,</span> <span class="n">naics_level</span>
                    <span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">plot_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

            <span class="n">len_naics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NAICS Code&#39;</span>
            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="c1"># formatting[&#39;color_discrete_sequence&#39;] = px.colors.sequential.Plasma_r</span>
            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;color_discrete_sequence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">sample_colorscale</span><span class="p">(</span>
                <span class="s2">&quot;plasma_r&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="n">len_naics</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_naics</span><span class="p">)]</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;unitTypeStd.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouper</span><span class="p">)</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;registryID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unit Count&#39;</span>
            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;registryID&#39;</span>

        <span class="k">elif</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;energy&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;unitTypeStd.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouper</span><span class="p">)[</span><span class="s1">&#39;energyMJ&#39;</span><span class="p">,</span> <span class="s1">&#39;energyMJq0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;energy&#39;</span>
            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;energy&#39;</span> 
            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Energy (MJ)&#39;</span>

        <span class="k">elif</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;capacity&#39;</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;unitTypeStd.notnull() &amp; designCapacityUOM==&#39;MW&#39;&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouper</span><span class="p">)</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;designCapacity&#39;</span>
            <span class="n">formatting</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;designCapacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unit Design Capacity (MW)&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No variable specified&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">plot_data</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;unitTypeStd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">unitTypeStd</span><span class="p">]</span>
        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">grouper</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="o">**</span><span class="n">formatting</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">showexponent</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                    <span class="n">exponentformat</span><span class="o">=</span><span class="s1">&#39;power&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write_fig</span><span class="p">:</span>
            <span class="n">pio</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;unittype_NAICS</span><span class="si">{</span><span class="n">naics_level</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig_format</span><span class="p">,</span>
                <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pio_engine</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FIED_analysis.make_consistent_naics_column">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.make_consistent_naics_column">[docs]</a>
    <span class="k">def</span> <span class="nf">make_consistent_naics_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final_data</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a column of consisently aggregated NAICS codes</span>
<span class="sd">        (i.e., same number of digits) when a column of </span>
<span class="sd">        NAICS codes contains different levels of aggregation.</span>
<span class="sd">        Will only include </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        final_data : pandas.DataFrame or parquet</span>

<span class="sd">        n : int; 2 to 6</span>
<span class="sd">            Specified NAICS level</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        analysis_data : pandas.DataFrame</span>
<span class="sd">            Returns original DataFrame with</span>
<span class="sd">            new column named f&#39;n{n}&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_naics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">final_data</span><span class="p">[</span><span class="s1">&#39;naicsCode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">df_naics_consistent</span> <span class="o">=</span> <span class="n">df_naics</span><span class="p">[</span>
            <span class="n">df_naics</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_naics_consistent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_naics</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caution: not all original NAICS codes are at this aggregation&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">df_naics_consistent</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_naics_consistent</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">analysis_data</span> <span class="o">=</span> <span class="n">final_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">analysis_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">analysis_data</span><span class="p">,</span> <span class="n">df_naics_consistent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;naicsCode&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">analysis_data</span></div>


    
<div class="viewcode-block" id="FIED_analysis.plot_best_characterized">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.plot_best_characterized">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_best_characterized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify which NAICS codes have the highest portion of facilities that</span>
<span class="sd">        have some unit-level characterization associated with them.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># find most aggregated NAICS (smallest number of digits)</span>
        <span class="n">smallest_n</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">smallest_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">smallest_n</span><span class="p">])</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_consistent_naics_column</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">smallest_n</span><span class="p">)</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;stateCode&#39;</span><span class="p">)</span> 

        <span class="n">plot_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">plot_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd.isnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">smallest_n</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">())),</span>
            <span class="n">x</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;unitTypeStd.notnull()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;n</span><span class="si">{</span><span class="n">smallest_n</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">()))],</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        
        <span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;unchar&#39;</span><span class="p">,</span> <span class="s1">&#39;char&#39;</span><span class="p">]</span>
        <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;fraction_char&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">total</span>
            <span class="p">)</span>
        
        <span class="n">plot_data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># # State sorted mean characterized</span>
        <span class="c1"># state_char = pd.concat(</span>
        <span class="c1">#     [plot_data.fraction_char.mean(level=0),</span>
        <span class="c1">#      plot_data.total.sum(level=0)], axis=1</span>
        <span class="c1">#     ).sort_values(by=&#39;fraction_char&#39;, ascending=False)</span>

        <span class="c1"># # NAICS sorted mean characterized</span>
        <span class="c1"># naics_char = pd.concat(</span>
        <span class="c1">#     [plot_data.fraction_char.mean(level=1),</span>
        <span class="c1">#      plot_data.total.sum(level=1)],</span>
        <span class="c1">#      axis=1</span>
        <span class="c1">#     ).sort_values(by=&#39;fraction_char&#39;, ascending=False)</span>
    
        <span class="c1"># Level 0 is state aggregation; level 1 is NAICS aggregation</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">plot_data</span><span class="o">.</span><span class="n">fraction_char</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">k</span><span class="p">),</span>
                <span class="n">plot_data</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">k</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;fraction_char&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                <span class="n">d</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">fraction_char</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;fraction_char&quot;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">6</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NAICS Code&#39;</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">)</span>
           
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Fraction of Facilities with Unit Characterization&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total Number of Facilities&#39;</span><span class="p">,</span> 
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span>
                <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

            

    <span class="c1"># def unit_capacity_nonintensive(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
        
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>

    <span class="c1">#     df : pandas.DataFrame</span>
    <span class="c1">#         Final foundational dataset</span>

    <span class="c1">#     naics : str; {&#39;all&#39;, &#39;non-mfg&#39;, &#39;intensive&#39;, &#39;other-mfg&#39;} or list of ints; default=&#39;all&#39;</span>
    <span class="c1">#         Group output by NAICS code group (str) or by list of integer(s). Integers must</span>
    <span class="c1">#         be at 4-digit NAICS level.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>

    <span class="c1">#     naics_plot : </span>
        
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     # plot_data = id_sectors(final_data)</span>

    <span class="c1">#     # Make subplots, one each for non-mfg,</span>
    <span class="c1">#     # intenstive, and other-mfg</span>
    <span class="c1">#     fig = make_subplots(</span>
    <span class="c1">#         rows=2, cols=2,</span>
    <span class="c1">#         specs=[</span>
    <span class="c1">#             [{}, {}],</span>
    <span class="c1">#             [{&quot;colspan&quot;: 2}, None]</span>
    <span class="c1">#             ],</span>
    <span class="c1">#         print_grid=False)</span>
        

<div class="viewcode-block" id="FIED_analysis.summary_table_intensive">
<a class="viewcode-back" href="../../../fied.analysis.html#fied.analysis.analysis_figures.FIED_analysis.summary_table_intensive">[docs]</a>
    <span class="k">def</span> <span class="nf">summary_table_intensive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summary description of unit coverage for intensive </span>
<span class="sd">        and non-intensive industries.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">df_naics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="n">df_naics</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;n4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_naics</span><span class="o">.</span><span class="n">naicsCode</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>

        <span class="n">plot_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">all</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fied</span><span class="p">,</span> <span class="n">df_naics</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;naicsCode&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># NAICS subsectors of Paper Manufacturing, Petroleum and Coal Products,</span>
        <span class="c1"># Chemical Manufacturing, Glass and Glass Product Manufacturing, Cement and</span>
        <span class="c1"># Concrete, Lime and Gypsum, Iron &amp; Steel, Alumina and Aluminum,</span>
        <span class="n">intensive_naics</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3221</span><span class="p">,</span> <span class="mi">3241</span><span class="p">,</span> <span class="mi">3251</span><span class="p">,</span> <span class="mi">3253</span><span class="p">,</span> <span class="mi">3272</span><span class="p">,</span> <span class="mi">3273</span><span class="p">,</span> <span class="mi">3274</span><span class="p">,</span> <span class="mi">3311</span><span class="p">,</span> <span class="mi">3313</span><span class="p">]</span>

        <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;non-mfg&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n4</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)]</span>

        <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;intensive&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">][</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n4</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">intensive_naics</span><span class="p">)]</span>

        <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;other-mfg&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">][</span>
                <span class="o">~</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n4</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">intensive_naics</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n4</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>      

        <span class="n">summ_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;intensive&#39;</span><span class="p">,</span> <span class="s1">&#39;other-mfg&#39;</span><span class="p">,</span> <span class="s1">&#39;non-mfg&#39;</span><span class="p">])</span>

        <span class="n">ind_grp</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grouping&#39;</span><span class="p">)</span>

        <span class="n">summ_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">ind_grp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">())),</span>
            <span class="n">ind_grp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">unitTypeStd</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="p">),</span>
            <span class="n">ind_grp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span>
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unitTypeStd</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">designCapacityUOM</span> <span class="o">==</span> <span class="s1">&#39;MW&#39;</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">registryID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="p">),</span>
            <span class="n">ind_grp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">designCapacityUOM</span> <span class="o">==</span> <span class="s1">&#39;MW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">),</span>
            <span class="n">ind_grp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">designCapacityUOM</span> <span class="o">==</span> <span class="s1">&#39;MW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">designCapacity</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                <span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="n">summ_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">summ_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">summ_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">summ_table</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Count of Facilities&#39;</span><span class="p">,</span> <span class="s1">&#39;Facilities with Unit Type&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Facilities with Unit Type &amp; Capacity&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Total Capacity (MW)&#39;</span><span class="p">,</span> <span class="s1">&#39;Median Capacity (MW)&#39;</span><span class="p">]</span>

        <span class="n">summ_table</span> <span class="o">=</span> <span class="n">summ_table</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">({</span>
            <span class="s1">&#39;Facilities with Unit Type&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.0%}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Facilities with Unit Type &amp; Capacity&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.0%}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Total Capacity (MW)&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="p">}</span>
            <span class="p">)</span></div>
</div>

        
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        
    <span class="n">year</span> <span class="o">=</span> <span class="mi">2017</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;foundational_industry_data_2017.csv.gz&#39;</span><span class="p">)</span>
    <span class="n">fa</span> <span class="o">=</span> <span class="n">FIED_analysis</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span> <span class="n">fig_format</span><span class="o">=</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span>

    <span class="n">fa</span><span class="o">.</span><span class="n">create_core_analysis</span><span class="p">(</span><span class="n">write_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2024, Alliance for Sustainable Energy, LLC..
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.9.1.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>