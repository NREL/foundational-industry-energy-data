<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>fied.frs.frs_extraction</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../index.html" class="home-link">
    
      <span class="site-name">The Foundational Industry Energy Dataset (FIED)</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../index.html#fied-documentation-and-other-resources-on-u-s-industrial-energy-data">Contents:</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../../ind_data.html" class="reference internal ">Sources of Industrial Energy Data for the United States</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../nrel_data.html" class="reference internal ">NREL Industrial Energy Datasets</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../data_history.html" class="reference internal ">A Brief History of U.S. Industrial Energy Data</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../fied.html" class="reference internal ">fied package</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../../index.html">Module code</a> &raquo;</li>
    
    <li>fied.frs.frs_extraction</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for fied.frs.frs_extraction</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="FRS">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS">[docs]</a>
<span class="k">class</span> <span class="nc">FRS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for extracting relevant facility-level</span>
<span class="sd">    data from EPA&#39;s Facility Registration Service (FRS) data.</span>

<span class="sd">    Documentation of FRS data fields:</span>
<span class="sd">    https://www.epa.gov/sites/default/files/2015-09/documents/frs_data_dictionary.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_frs_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./data/FRS&#39;</span><span class="p">)</span>

        <span class="c1"># Names of relevant FRS data files and columns.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_names_columns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>
            <span class="s1">&#39;PROGRAM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL_BUS_IND&#39;</span><span class="p">,</span> <span class="s1">&#39;ENV_JUSTICE_CODE&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;PGM_SYS_ACRNM&#39;</span><span class="p">,</span> <span class="s1">&#39;PGM_SYS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;SENSITIVE_IND&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;STD_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_LOC_ADDRESS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;STD_COUNTY_FIPS&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_CITY_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_COUNTY_NAME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;STD_STATE_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_POSTAL_CODE&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;LEGISLATIVE_DIST_NUM&#39;</span><span class="p">,</span> <span class="s1">&#39;HUC_CODE_8&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;SITE_TYPE_NAME&#39;</span><span class="p">],</span>
            <span class="s1">&#39;FACILITY&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EPA_REGION_CODE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;LATITUDE83&#39;</span><span class="p">,</span> <span class="s1">&#39;LONGITUDE83&#39;</span>
                <span class="p">],</span>
            <span class="s1">&#39;NAICS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">],</span>
            <span class="s1">&#39;single&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;PRIMARY_NAME&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;LOCATION_ADDRESS&#39;</span><span class="p">,</span> <span class="s1">&#39;SUPPLEMENTAL_LOCATION&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;CITY_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTY_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;FIPS_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;STATE_CODE&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;STATE_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;POSTAL_CODE&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;TRIBAL_LAND_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;CONGRESSIONAL_DIST_NUM&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;CENSUS_BLOCK_CODE&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;HUC_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;SITE_TYPE_NAME&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;US_MEXICO_BORDER_IND&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;LATITUDE83&#39;</span><span class="p">,</span> <span class="s1">&#39;LONGITUDE83&#39;</span><span class="p">]</span>
            <span class="c1"># &#39;PROGRAM&#39;: [&#39;REGISTRY_ID&#39;, &#39;SMALL_BUS_IND&#39;, &#39;ENV_JUSTICE_CODE&#39;,</span>
            <span class="c1">#             &#39;PGM_SYS_ACRNM&#39;, &#39;PGM_SYS_ID&#39;, &#39;SENSITIVE_IND&#39;]</span>
            <span class="c1"># &#39;ORGANIZATION&#39;: [</span>
            <span class="c1">#     &#39;REGISTRY_ID&#39;, &#39;PGM_SYS_ACRNM&#39;, &#39;PGM_SYS_ID&#39;, &#39;EIN&#39;,</span>
            <span class="c1">#     &#39;DUNS_NUMBER&#39;, &#39;ORG_NAME&#39;, ORG_TYPE</span>
            <span class="c1">#     ],  #TODO CSV contains useful data, but many ORG_NAME, etc. for a given RegistryID </span>
            <span class="p">})</span>

        <span class="c1"># Dictionary of relevant data categories (keys) and variables (values)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_format</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>
            <span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;CITY_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTY_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;FIPS_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;STATE_CODE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;POSTAL_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;TRIBAL_LAND_CODE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;CONGRESSIONAL_DIST_NUM&#39;</span><span class="p">,</span> <span class="s1">&#39;CENSUS_BLOCK_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;HUC_CODE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EPA_REGION_CODE&#39;</span>
                <span class="p">],</span>
            <span class="s1">&#39;facility&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;PRIMARY_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;LATITUDE83&#39;</span><span class="p">,</span> <span class="s1">&#39;LONGITUDE83&#39;</span><span class="p">,</span>
                <span class="s1">&#39;LOCATION_ADDRESS&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL_BUS_IND&#39;</span><span class="p">,</span> <span class="s1">&#39;ENV_JUSTICE_CODE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;NAICS_CODE_additional&#39;</span><span class="p">,</span> <span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;SITE_TYPE_NAME&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SENSITIVE_IND&#39;</span><span class="p">,</span> <span class="s1">&#39;ENERGY_EST_SOURCE&#39;</span>
                <span class="p">]</span>
            <span class="p">})</span>

<div class="viewcode-block" id="FRS.call_all_fips">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.call_all_fips">[docs]</a>
    <span class="k">def</span> <span class="nf">call_all_fips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses Census API to call all state and county fips codes.</span>
<span class="sd">        Excludes U.S. territories and outerlying areas.</span>
<span class="sd">        Combines with file on stat abbrevitions and zip codes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        all_fips : json</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fips_url</span> <span class="o">=</span> <span class="s1">&#39;https://api.census.gov/data/2010/dec/sf1?&#39;</span>
        <span class="n">fips_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">:</span> <span class="s1">&#39;county:*&#39;</span><span class="p">}</span>

        <span class="n">state_abbr_url</span> <span class="o">=</span> \
            <span class="s1">&#39;https://www2.census.gov/geo/docs/reference/state.txts&#39;</span>

        <span class="n">zip_code_url</span> <span class="o">=</span> \
            <span class="s1">&#39;https://postalpro.usps.com/mnt/glusterfs/2022-12/ZIP_Locale_Detail.xls&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fips_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">fips_params</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_fips_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="n">all_fips_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">all_fips_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">all_fips_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">all_fips_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;state_abbr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_fips_df</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">state_abbr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">state_abbr_url</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;|&#39;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error with fips csv: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_abbr</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">state_abbr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">state_abbr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;state_abbr&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zip_codes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">zip_code_url</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error with zip code xls:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">zip_codes</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">zip_codes</span><span class="o">.</span><span class="n">columns</span>
                <span class="p">]</span>
            <span class="n">zip_codes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">coumns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;physical_state&#39;</span><span class="p">:</span> <span class="s1">&#39;state_abbr&#39;</span><span class="p">},</span>
                              <span class="n">inplace</span><span class="o">=</span><span class="n">true</span><span class="p">)</span>

        <span class="n">all_fips_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">all_fips_df</span><span class="p">,</span> <span class="n">state_abbr</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;state_abbr&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">)</span>
        <span class="n">all_fips_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">all_fips_df</span><span class="p">,</span> <span class="n">zip_codes</span><span class="p">[[</span><span class="s1">&#39;physical_zip&#39;</span><span class="p">,</span> <span class="s1">&#39;state_abbr&#39;</span><span class="p">]],</span>
            <span class="n">on</span><span class="o">=</span><span class="s1">&#39;state_abbr&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">)</span>

        <span class="n">all_fips</span> <span class="o">=</span> <span class="n">all_fips_df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
        <span class="n">all_fips</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">all_fips</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_fips</span></div>


<div class="viewcode-block" id="FRS.download_unzip_frs_data">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.download_unzip_frs_data">[docs]</a>
    <span class="k">def</span> <span class="nf">download_unzip_frs_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download bulk FRS data files from EPA.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">combined</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;combined&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>

        <span class="c1"># Combined file is ~732 MB as of December 2022</span>
        <span class="n">frs_url</span> <span class="o">=</span> \
            <span class="sa">f</span><span class="s2">&quot;https://ordsext.epa.gov/FLA/www3/state_files/national_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.zip&quot;</span>

        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frs_data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;national_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frs_data_path</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frs_data_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRS </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> zip file exists.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRS </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> zip file does not exist. Downloading...&quot;</span><span class="p">)</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">frs_url</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># Unzip with zipfile</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frs_data_path</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRS </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> file unzipped.&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="FRS.fix_code">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.fix_code">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fix_code</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fix codes that should be int, not float or str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code_fixed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">code</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">code_fixed</span></div>


<div class="viewcode-block" id="FRS.format_program_csv">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.format_program_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">format_program_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">programs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds dataframe from FRS_PROGRAM dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : pandas.DataFrame</span>
<span class="sd">            Initial imported DataFrame.</span>

<span class="sd">        programs : list</span>
<span class="sd">            List of program system acronyms to extract.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : pandas.DataFrame</span>
<span class="sd">            Formatted FRS data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">programs</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;PGM_SYS_ACRNM==@a&quot;</span><span class="p">)[</span>
                <span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;PGM_SYS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;PGM_SYS_ACRNM&#39;</span><span class="p">]</span>
                <span class="p">])</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;PGM_SYS_ID_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">PGM_SYS_ID</span>

            <span class="c1"># Facilities may have &gt;1 program system ID, which</span>
            <span class="c1"># leads to duplicate entries when indexing by REGISTRY_ID.</span>
            <span class="n">dups</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">REGISTRY_ID</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">REGISTRY_ID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s1">&#39;PGM_SYS_ID_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_additional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dups</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">REGISTRY_ID</span> <span class="o">==</span> <span class="n">d</span><span class="p">]</span>
                    <span class="n">use_index</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
                        <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">index</span>
                    <span class="c1"># logging.info(f&#39;registry ID: {d}\nLength of IDs: {len(ids)}&#39;)</span>
                    <span class="c1"># for i, v in enumerate(ids[1:].index):</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">use_index</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PGM_SYS_ID_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_additional&#39;</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="sa">f</span><span class="s1">&#39;PGM_SYS_ID_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
                            <span class="c1"># data_dict[a].loc[v, f&#39;PGM_SYS_ID_{a}&#39;]</span>

                <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
                    <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span>
                    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

            <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;PGM_SYS_ACRNM&#39;</span><span class="p">,</span> <span class="s1">&#39;PGM_SYS_ID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="n">data_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;PGM_SYS_ACRNM&#39;</span><span class="p">,</span> <span class="s1">&#39;PGM_SYS_ID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pgm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pgm_data</span><span class="p">)</span>

        <span class="c1"># pgm_data = pgm_data.reindex(index=data.index)</span>
        <span class="c1"># pgm_data.update(data)</span>

        <span class="c1"># data = pd.DataFrame(pgm_data)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="FRS.format_naics_csv">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.format_naics_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">format_naics_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds dataframe from FRS_FACILITY dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : pandas.DataFrame</span>
<span class="sd">            Initial imported DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : pandas.DataFrame</span>
<span class="sd">            Formatted FRS data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Duplicate NAICS codes for facililities. Keep first</span>
        <span class="c1"># and move remaining to NAICS_CODE_additional.</span>
        <span class="c1"># Assume that a facility with any industry NAICS</span>
        <span class="c1"># code (i.e., 11, 21, 23, 31-33) is</span>
        <span class="c1"># an industrial facility</span>
        <span class="n">all_naics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">NAICS_CODE</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">all_naics</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_naics</span><span class="o">.</span><span class="n">NAICS_CODE</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">all_naics</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;ind==True&quot;</span><span class="p">)</span>

        <span class="n">data_unique</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span>
            <span class="p">)</span>

        <span class="n">dups</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">data_unique</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">dups</span> <span class="o">=</span> <span class="n">dups</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="n">dups</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NAICS_CODE_additional&#39;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">data_unique</span><span class="p">,</span> <span class="n">dups</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;ind&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="FRS.read_frs_csv">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.read_frs_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">read_frs_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">programs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EIS&#39;</span><span class="p">,</span> <span class="s1">&#39;E-GGRT&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds dataframe based on FRS datasets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            String for name of FRS csv file. All csv files</span>
<span class="sd">            extracted from national_combined.zip are named according</span>
<span class="sd">            to &quot;NATIONAL_{name}_FILE.CSV&quot;.</span>

<span class="sd">        columns : list</span>
<span class="sd">            List of columns to extract from csv.</span>

<span class="sd">        programs : list; [&#39;EIS&#39;, &#39;E-GGRT&#39;]</span>
<span class="sd">            List of program system acronyms to extract from</span>
<span class="sd">            NATIONAL_PROGRAM_FILE.CSV.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : pandas.DataFrame</span>
<span class="sd">            Formatted FRS data, based on FACILITY, ORGANIZATION,</span>
<span class="sd">            NAICS, and PROGRAM datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NATIONAL_</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">.CSV&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;NATIONAL_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_FILE.CSV&#39;</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frs_data_path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">file_path</span><span class="p">,</span>
            <span class="n">usecols</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;PROGRAM&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_program_csv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">programs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NAICS&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_naics_csv</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;FACILITY&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="FRS.build_frs_json">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.build_frs_json">[docs]</a>
    <span class="k">def</span> <span class="nf">build_frs_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frs_data_df</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frs_data_df : pandas.DataFrame</span>
<span class="sd">            Dataframe from formatted FRS csv datasets.</span>

<span class="sd">        ret : bool; default == False</span>
<span class="sd">            Returns FRS data in json format.</span>

<span class="sd">        save_path : str; default == None</span>
<span class="sd">            Directory to save FRS data in json file.</span>
<span class="sd">            Must specify to save.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        frs_json : json, optional.</span>
<span class="sd">            Dictionary of facility data extracted from FRS in</span>
<span class="sd">            JSON format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Fix formatting</span>
        <span class="n">fix_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;POSTAL_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;CONGRESSIONAL_DIST_NUM&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;CENSUS_BLOCK_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;HUC_CODE&#39;</span><span class="p">,</span> <span class="s1">&#39;EPA_REGION_CODE&#39;</span><span class="p">,</span>
                     <span class="p">]</span>

        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">fix_codes</span><span class="p">:</span>
            <span class="n">frs_data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">frs_data_df</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">FRS</span><span class="o">.</span><span class="n">fix_code</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">frs_data_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Must first transpose DF</span>
        <span class="n">frs_data_df</span> <span class="o">=</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">T</span>
        <span class="n">frs_data_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;VARIABLE&#39;</span>
        <span class="n">frs_data_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">frs_data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;CATEGORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_format</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;VARIABLE&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">frs_data_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;CATEGORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">frs_data_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;CATEGORY&#39;</span><span class="p">,</span> <span class="s1">&#39;VARIABLE&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">val_dict</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_format</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>  <span class="c1"># nested dict, e.g., {&#39;site&#39; : {1000: {NAICS_CODE: 2111}}}</span>

        <span class="c1"># Previous approach used dict.fromkeys, which didn&#39;t work for setting values from</span>
        <span class="c1"># val_dict</span>
        <span class="n">frs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="p">[{</span><span class="n">c</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;found_ind_data.json.gz&#39;</span><span class="p">),</span>
                           <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">frs_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="n">frs_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">frs_dict</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">frs_json</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="FRS.add_frs_columns_json">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.add_frs_columns_json">[docs]</a>
    <span class="k">def</span> <span class="nf">add_frs_columns_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frs_data_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add columns that capture multiple program IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting fields:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_format</span><span class="p">[</span><span class="s2">&quot;facility&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">frs_data_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;PGM_SYS_ID&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_json_format</span><span class="p">[</span><span class="s1">&#39;facility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ending fields:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_format</span><span class="p">[</span><span class="s2">&quot;facility&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="FRS.import_format_frs">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.import_format_frs">[docs]</a>
    <span class="k">def</span> <span class="nf">import_format_frs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import and format downloaded frs files</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_dir : str</span>
<span class="sd">            Directory of FRS files.</span>

<span class="sd">        combined : bool; default is True</span>
<span class="sd">            Indicate whether the data set is constructed using</span>
<span class="sd">            the EPA FRS single file or combined files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        final_data : pandas.DataFrame</span>
<span class="sd">            DataFrame indexed by REGISTRY_ID, containing</span>
<span class="sd">            relevant site and facility data from EPA FRS. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Reminder that self._names_columns is an ordered dict</span>
        <span class="n">pgm_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_frs_csv</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;PROGRAM&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_names_columns</span><span class="p">[</span><span class="s1">&#39;PROGRAM&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">naics_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_frs_csv</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;NAICS&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_names_columns</span><span class="p">[</span><span class="s1">&#39;NAICS&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">combined</span><span class="p">:</span>
            <span class="n">fac_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_frs_csv</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FACILITY&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_names_columns</span><span class="p">[</span><span class="s1">&#39;FACILITY&#39;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">final_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">pgm_data</span><span class="p">,</span> <span class="n">fac_data</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fac_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_frs_csv</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_names_columns</span><span class="p">[</span><span class="s1">&#39;single&#39;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">final_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">fac_data</span><span class="p">,</span> <span class="n">pgm_data</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
                <span class="p">)</span>

        <span class="n">final_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">final_data</span><span class="p">,</span> <span class="n">naics_data</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">)</span>

        <span class="c1"># All dataframes but the NAICS dataframe have non-industrial</span>
        <span class="c1"># facilities. Drop facilities that don&#39;t have NAICS codes after</span>
        <span class="c1"># merging.</span>
        <span class="n">final_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">final_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;REGISTRY_ID&#39;</span><span class="p">:</span> <span class="s1">&#39;registryID&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LEGISLATIVE_DIST_NUM&#39;</span><span class="p">:</span> <span class="s1">&#39;legislativeDistrictNumber&#39;</span><span class="p">,</span>
            <span class="s1">&#39;HUC_CODE_8&#39;</span><span class="p">:</span> <span class="s1">&#39;hucCode8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SITE_TYPE_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;siteTypeName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_LOC_ADDRESS&#39;</span><span class="p">:</span> <span class="s1">&#39;locationAddress&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_POSTAL_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;postalCode&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_CITY_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;cityName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_COUNTY_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;countyName&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_STATE_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;stateCode&#39;</span><span class="p">,</span>
            <span class="s1">&#39;STD_COUNTY_FIPS&#39;</span><span class="p">:</span> <span class="s1">&#39;countyFIPS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SENSITIVE_IND&#39;</span><span class="p">:</span> <span class="s1">&#39;sensitiveInd&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SMALL_BUS_IND&#39;</span><span class="p">:</span> <span class="s1">&#39;smallBusInd&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ENV_JUSTICE_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;envJusticeCode&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PGM_SYS_ID_EIS&#39;</span><span class="p">:</span> <span class="s1">&#39;eisFacilityID&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PGM_SYS_ID_EIS_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;eisFacilityIDAdditional&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PGM_SYS_ID_E-GGRT&#39;</span><span class="p">:</span> <span class="s1">&#39;ghgrpID&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PGM_SYS_ID_E-GGRT_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;ghgrpIDAdditional&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EPA_REGION_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;epaRegionCode&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LATITUDE83&#39;</span><span class="p">:</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LONGITUDE83&#39;</span><span class="p">:</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NAICS_CODE&#39;</span><span class="p">:</span> <span class="s1">&#39;naicsCode&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NAICS_CODE_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;naicsCodeAdditional&#39;</span>
            <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="c1"># for i, v in enumerate(self._names_columns.items()):</span>
        <span class="c1">#     if i == 0:</span>
        <span class="c1">#         frs_data_df = self.read_frs_csv(name=v[0], columns=v[1])</span>
        <span class="c1">#         frs_data_df.set_index(&#39;REGISTRY_ID&#39;, inplace=True)</span>
        <span class="c1">#         logging.info(f&#39;File name: {v[0]}\nDF len: {len(frs_data_df)}&#39;)</span>

        <span class="c1">#     elif i &lt; 4:</span>
        <span class="c1">#         data = self.read_frs_csv(name=v[0], columns=v[1])</span>
        <span class="c1">#         data.set_index(&#39;REGISTRY_ID&#39;, inplace=True)</span>
        <span class="c1">#         logging.info(f&#39;File name: {v[0]}\nDF len: {len(data)}&#39;)</span>

        <span class="c1">#         frs_data_df = pd.merge(</span>
        <span class="c1">#             frs_data_df, data, left_index=True,</span>
        <span class="c1">#             right_index=True, how=&#39;left&#39;</span>
        <span class="c1">#             )</span>
        <span class="c1">#         logging.info(f&#39;File len: {len(frs_data_df)}&#39;)</span>

        <span class="c1">#     else:</span>
        <span class="c1">#         continue</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final len: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">final_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;registryID&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_data</span></div>


    <span class="c1"># TODO </span>
<div class="viewcode-block" id="FRS.load_foundational_json">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.load_foundational_json">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_foundational_json</span><span class="p">(</span><span class="n">found_json_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load json file of foundational energy data.</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">found_json_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzfile</span><span class="p">:</span>
            <span class="c1"># with json.load(gfile) as jfile:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">gzfile</span><span class="p">),</span>
                                               <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="n">frs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">json_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">json_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>

            <span class="n">column_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_data</span><span class="p">))],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

            <span class="n">column_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">frs_data</span><span class="o">.</span><span class="n">index</span>

            <span class="n">frs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">frs_data</span><span class="p">,</span> <span class="n">column_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="FRS.find_eis">
<a class="viewcode-back" href="../../../fied.frs.html#fied.frs.frs_extraction.FRS.find_eis">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_eis</span><span class="p">(</span><span class="n">acrnm</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull out EIS ID from program system field</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        acrnm : str</span>
<span class="sd">            String of program system names and IDs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        eis : str or None</span>
<span class="sd">            Returns string if EIS in program system field; None if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">eis</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=EIS:)\w+&#39;</span><span class="p">,</span> <span class="n">acrnm</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">eis</span> <span class="o">=</span> <span class="n">eis</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">eis</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">eis</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># t_start = time.perf_counter()</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">frs_methods</span> <span class="o">=</span> <span class="n">FRS</span><span class="p">()</span>
    <span class="n">frs_methods</span><span class="o">.</span><span class="n">download_unzip_frs_data</span><span class="p">(</span><span class="n">combined</span><span class="o">=</span><span class="n">combined</span><span class="p">)</span>

    <span class="n">frs_data_df</span> <span class="o">=</span> <span class="n">frs_methods</span><span class="o">.</span><span class="n">import_format_frs</span><span class="p">(</span><span class="n">combined</span><span class="o">=</span><span class="n">combined</span><span class="p">)</span>
    <span class="n">frs_data_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;./data/FRS/frs_data_formatted.csv&#39;</span><span class="p">)</span>

    <span class="c1"># t_stop = time.perf_counter()</span>
    <span class="c1"># logging.info(f&#39;Program time: {t_stop - t_start:0.2f} seconds&#39;)</span>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2024, Alliance for Sustainable Energy, LLC..
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.9.1.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>